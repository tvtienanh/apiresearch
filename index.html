<!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Cơ sở dữ liệu nguyên liệu làm thuốc</title>
        <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f5f7fa;
                color: #2d3748;
                min-height: 100vh;
                line-height: 1.5;
            }
            
            .app-container {
                min-height: 100vh;
                width: 100%;
            }
            
            /* Header Section */
            .header-section {
                background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
                border-bottom: 2px solid #e2e8f0;
                padding: 24px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .main-title {
                text-align: center;
                color: #2b6cb0;
                font-size: 28px;
                font-weight: 600;
                margin-bottom: 24px;
                letter-spacing: -0.3px;
            }
            
            .control-panel {
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 16px;
                margin-bottom: 16px;
            }
            
            .left-controls {
                display: flex;
                align-items: center;
                gap: 16px;
                flex-wrap: wrap;
            }
            
            .right-controls {
                display: flex;
                align-items: center;
                gap: 12px;
            }
            
            .stats-display {
                display: flex;
                gap: 16px;
                align-items: center;
                font-size: 14px;
                color: #2d3748;
            }
            
            .stat-badge {
                background: #e6f3ff;
                color: #2b6cb0;
                padding: 8px 16px;
                border-radius: 20px;
                font-weight: 500;
                border: 1px solid #bee3f8;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            .control-group {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .control-label {
                font-size: 14px;
                font-weight: 500;
                color: #2d3748;
                white-space: nowrap;
            }
            
            .items-per-page-select {
                padding: 8px 12px;
                border: 1px solid #cbd5e0;
                border-radius: 6px;
                background: white;
                font-size: 14px;
                color: #2d3748;
                cursor: pointer;
                transition: all 0.2s ease;
                font-weight: 500;
            }
            
            .items-per-page-select:focus {
                outline: none;
                border-color: #3182ce;
                box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
            }
            
            .btn {
                padding: 10px 16px;
                border: none;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                gap: 6px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .btn-primary {
                background: #3182ce;
                color: white;
            }
            
            .btn-primary:hover {
                background: #2c5aa0;
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(49, 130, 206, 0.3);
            }
            
            .btn-outline {
                background: white;
                color: #3182ce;
                border: 1px solid #3182ce;
            }
            
            .btn-outline:hover {
                background: #ebf8ff;
                border-color: #2c5aa0;
            }
            
            .btn-outline.active {
                background: #ebf8ff;
                border-color: #2c5aa0;
                color: #2c5aa0;
            }
            
            /* Filter Section */
            .filter-section {
                background: white;
                border-bottom: 1px solid #e2e8f0;
                overflow: hidden;
                transition: all 0.3s ease;
                max-height: 0;
                opacity: 0;
            }
            
            .filter-section.expanded {
                max-height: 220px;
                opacity: 1;
                padding: 20px 24px;
            }
            
            .filters-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 16px;
            }
            
            .filter-group {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }
            
            .filter-label {
                font-size: 12px;
                font-weight: 500;
                color: #2d3748;
                text-transform: uppercase;
                letter-spacing: 0.3px;
            }
            
            .filter-input {
                padding: 10px 12px;
                border: 1px solid #cbd5e0;
                border-radius: 4px;
                font-size: 13px;
                transition: all 0.2s ease;
                background: #fafafa;
                color: #2d3748;
            }
            
            .filter-input:focus {
                outline: none;
                border-color: #3182ce;
                background: white;
                box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
            }
            
            .filter-input::placeholder {
                color: #9ca3af;
            }
            
            /* Table Section */
            .table-section {
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                min-height: 60vh;
                margin-top: 1px;
            }
            
            .table-header {
                background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
                padding: 16px 24px;
                border-bottom: 2px solid #e2e8f0;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .table-title {
                font-size: 18px;
                font-weight: 600;
                color: #2d3748;
            }
            
            .table-wrapper {
                width: 100%;
                overflow-x: auto;
            }
            
            .data-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 13px;
                background: white;
                table-layout: fixed !important;
                border-spacing: 0 !important;
            }
            
            /* Force column widths with highest specificity */
            .data-table th.col-stt,
            .data-table td.col-stt { 
                width: 40px !important; 
                min-width: 40px !important; 
                max-width: 40px !important;
                box-sizing: border-box !important;
            }
            
            .data-table th.col-so-dk,
            .data-table td.col-so-dk { 
                width: 12% !important; 
                min-width: 100px !important;
                white-space: pre-line !important;
                word-break: break-word !important;
                line-height: 1.3 !important;
                overflow-wrap: break-word !important;
                word-wrap: break-word !important;
                hyphens: auto !important;
                height: auto !important;
                min-height: 60px !important;
                box-sizing: border-box !important;
            }
            
            .data-table th.col-ten-thuoc,
            .data-table td.col-ten-thuoc { 
                width: 16% !important; 
                min-width: 150px !important; 
                box-sizing: border-box !important;
            }
            
            .data-table th.col-ngay,
            .data-table td.col-ngay { 
                width: 11% !important; 
                min-width: 80px !important; 
                box-sizing: border-box !important;
            }
            
            .data-table th.col-nguyen-lieu,
            .data-table td.col-nguyen-lieu { 
                width: 18% !important; 
                min-width: 175px !important; 
                box-sizing: border-box !important;
            }
            
            .data-table th.col-phan-loai,
            .data-table td.col-phan-loai { 
                width: 6% !important; 
                min-width: 60px !important;
                white-space: normal !important;
                word-wrap: break-word !important;
                box-sizing: border-box !important;
            }
            
            .data-table th.col-tieu-chuan,
            .data-table td.col-tieu-chuan { 
                width: 8% !important; 
                min-width: 80px !important; 
                box-sizing: border-box !important;
            }
            
            .data-table th.col-co-so-dk,
            .data-table td.col-co-so-dk { 
                width: 18% !important; 
                min-width: 175px !important; 
                box-sizing: border-box !important;
            }
            
            .data-table th.col-cssx-nl,
            .data-table td.col-cssx-nl { 
                width: 16% !important; 
                min-width: 160px !important; 
                box-sizing: border-box !important;
            }
            
            .data-table th.col-dia-chi,
            .data-table td.col-dia-chi { 
                width: 120px !important; 
                min-width: 120px !important;
                max-width: 120px !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                word-break: normal !important;
                text-align: left !important;
                padding-left: 12px !important;
                box-sizing: border-box !important;
            }
            
            .data-table th.col-nuoc,
            .data-table td.col-nuoc { 
                width: 8% !important; 
                min-width: 100px !important; 
                box-sizing: border-box !important;
            }
            
            /* Basic table styling */
            .data-table th,
            .data-table td {
                padding: 12px 8px;
                text-align: center;
                border: 1px solid #e2e8f0;
                vertical-align: middle;
                word-wrap: break-word;
                line-height: 1.5;
                height: 60px;
                box-sizing: border-box;
            }
            
            .data-table th {
                background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%);
                font-weight: 600;
                color: #2d3748;
                text-transform: uppercase;
                font-size: 11px;
                letter-spacing: 0.3px;
                border-bottom: 2px solid #3182ce;
                height: 65px;
            }
            
            .data-table tbody tr {
                transition: all 0.2s ease;
                height: 60px;
            }
            
            .data-table tbody tr:nth-child(even) {
                background-color: #f8fafc;
            }
            
            .data-table tbody tr:hover {
                background-color: #ebf8ff;
                box-shadow: 0 2px 4px rgba(49,130,206,0.2);
            }
            
            /* Áp dụng kích thước cột cho header cells */
            .data-table th:nth-child(1) { 
                width: 4% !important; 
                min-width: 40px !important; 
                max-width: 40px !important;
            }
            .data-table th:nth-child(2) { 
                width: 16% !important; 
                min-width: 110px !important;
                white-space: pre-line !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                word-wrap: break-word !important;
            }
            .data-table th:nth-child(3) { 
                width: 16% !important; 
                min-width: 150px !important; 
            }
            .data-table th:nth-child(4) { 
                width: 11% !important; 
                min-width: 80px !important; 
            }
            .data-table th:nth-child(5) { 
                width: 18% !important; 
                min-width: 175px !important; 
            }
            .data-table th:nth-child(6) { 
                width: 6% !important; 
                min-width: 60px !important; 
            }
            .data-table th:nth-child(7) { 
                width: 8% !important; 
                min-width: 80px !important; 
            }
            .data-table th:nth-child(8) { 
                width: 18% !important; 
                min-width: 175px !important; 
            }
            .data-table th:nth-child(9) { 
                width: 16% !important; 
                min-width: 160px !important; 
            }
            .data-table th:nth-child(10) { 
                width: 150px !important; 
                min-width: 150px !important; 
                max-width: 150px !important; 
            }
            .data-table th:nth-child(11) { 
                width: 6% !important; 
                min-width: 60px !important; 
            }
            
            /* Loại bỏ webkit scrollbar styling */
            .table-wrapper {
                scrollbar-width: thin;
                scrollbar-color: #cbd5e0 #f7fafc;
            }
            
            /* Footer Section */
            .footer-section {
                background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
                border-top: 2px solid #e2e8f0;
                padding: 16px 24px;
                box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
                margin-top: 20px;
            }
            
            .pagination-container {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 8px;
                flex-wrap: wrap;
            }
            
            .page-btn {
                padding: 10px 14px;
                border: 1px solid #cbd5e0;
                background: white;
                color: #2d3748;
                text-decoration: none;
                border-radius: 6px;
                font-size: 13px;
                font-weight: 500;
                transition: all 0.2s ease;
                min-width: 44px;
                text-align: center;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            .page-btn:hover:not(.disabled) {
                background: #ebf8ff;
                border-color: #3182ce;
                color: #2b6cb0;
                transform: translateY(-1px);
            }
            
            .page-btn.active {
                background: #3182ce;
                border-color: #3182ce;
                color: white;
                box-shadow: 0 2px 4px rgba(49,130,206,0.3);
            }
            
            .page-btn.disabled {
                opacity: 0.5;
                cursor: not-allowed;
                pointer-events: none;
            }
            
            /* Loading Overlay */
            .loading-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(245, 247, 250, 0.9);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                backdrop-filter: blur(2px);
            }
            
            .loading-content {
                text-align: center;
                padding: 32px;
                background: white;
                border-radius: 12px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.15);
                border: 1px solid #e2e8f0;
            }
            
            .spinner {
                width: 40px;
                height: 40px;
                border: 3px solid #f1f5f9;
                border-top: 3px solid #3182ce;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 16px;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .loading-text {
                color: #2d3748;
                font-size: 14px;
                font-weight: 500;
            }
            
            /* Responsive Design */
            @media (max-width: 1200px) {
                .control-panel {
                    flex-direction: column;
                    align-items: stretch;
                }
                
                .left-controls,
                .right-controls {
                    justify-content: center;
                }
            }
            
            @media (max-width: 768px) {
                .data-table th,
                .data-table td {
                    padding: 10px 6px; /* Giảm padding cho mobile */
                    height: 55px; /* Mobile: giảm xuống 55px */
                }
                
                .data-table th {
                    height: 60px; /* Mobile: header 60px */
                }
                
                .pagination-container {
                    gap: 4px;
                }
                
                .page-btn {
                    padding: 8px 12px;
                    font-size: 12px;
                    min-width: 36px;
                }
            }
            
            /* Utility Classes */
            .text-muted {
                color: #6b7280 !important;
                font-weight: 400;
            }
            
            .font-weight-bold {
                font-weight: 600 !important;
            }
            
            .d-none {
                display: none !important;
            }
            
            .fade-in {
                animation: fadeIn 0.3s ease-in;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-5px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            /* Text readability improvements */
            .data-table td {
                color: #2d3748;
                font-weight: 400;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            /* Tooltip for truncated text */
            .data-table td[title]:hover {
                position: relative;
                cursor: help;
            }
            
            /* Smooth scrolling */
            html {
                scroll-behavior: smooth;
            }
            
            /* Back to top button */
            .back-to-top {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #3182ce;
                color: white;
                border: none;
                border-radius: 50%;
                width: 48px;
                height: 48px;
                font-size: 16px;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(49,130,206,0.3);
                transition: all 0.3s ease;
                opacity: 0;
                visibility: hidden;
                z-index: 200;
                font-weight: 500;
            }
            
            .back-to-top.visible {
                opacity: 1;
                visibility: visible;
            }
            
            .back-to-top:hover {
                background: #2c5aa0;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(49,130,206,0.4);
            }

            /* Text alignment - left align for most columns, center for specific ones */
            .col-stt,
            .col-so-dk,
            .col-ngay,
            .col-tieu-chuan,
            .col-nuoc {
                text-align: center !important;
            }

            .col-ten-thuoc,
            .col-nguyen-lieu,
            .col-co-so-dk,
            .col-cssx-nl,
            .col-dia-chi {
                text-align: left !important;
                padding-left: 12px !important;
            }

            /* Enable text wrapping for all columns */
            .data-table td {
                white-space: normal !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                hyphens: auto;
            }

            /* Chat button */
            .chat-button {
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: #1e88e5;
                color: white;
                border: none;
                border-radius: 50%;
                width: 56px;
                height: 56px;
                font-size: 20px;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(30, 136, 229, 0.4);
                transition: all 0.3s ease;
                z-index: 200;
                font-weight: 500;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .chat-button:hover {
                background: #1976d2;
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(30, 136, 229, 0.5);
            }

            .chat-button:active {
                transform: translateY(0);
            }

            /* Chat icon animation */
            .chat-button::before {
                content: '';
                font-size: 24px;
                animation: bounce 2s infinite;
            }

            @keyframes bounce {
                0%, 20%, 50%, 80%, 100% {
                    transform: translateY(0);
                }
                40% {
                    transform: translateY(-3px);
                }
                60% {
                    transform: translateY(-2px);
                }
            }
        </style>
    </head>
    <body>
        <div class="app-container">
            <!-- Header Section -->
            <div class="header-section">
                <h1 class="main-title">Cơ sở dữ liệu nguyên liệu làm thuốc</h1>
                
                <div class="control-panel">
                    <div class="left-controls">
                        <div class="stats-display">
                            <div class="stat-badge">
                                Tổng số bản ghi: <span id="totalCount" class="font-weight-bold">0</span>
                            </div>
                            <div class="stat-badge d-none" id="filteredInfo">
                                Đã lọc: <span id="filteredCount" class="font-weight-bold">0</span>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Số dòng mỗi trang:</label>
                            <select class="items-per-page-select" id="itemsPerPageSelect">
                                <option value="50">50</option>
                                <option value="100" selected>100</option>
                                <option value="200">200</option>
                                <option value="300">300</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="right-controls">
                        <button class="btn btn-outline" id="toggleFiltersBtn" onclick="toggleFilters()">
                            <span id="filterBtnText">Hiển thị bộ lọc</span>
                        </button>
                        <button class="btn btn-primary" onclick="exportToExcel()">
                            Xuất Excel
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="filter-section" id="filterSection">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Tên thuốc</label>
                        <input type="text" class="filter-input" id="filterTenThuoc" placeholder="Tìm kiếm tên thuốc...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Số đăng ký</label>
                        <input type="text" class="filter-input" id="filterSoDangKy" placeholder="Tìm kiếm số đăng ký...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Ngày hết hạn SĐK</label>
                        <input type="text" class="filter-input" id="filterNgayHetHan" placeholder="Tìm kiếm ngày hết hạn...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Tên nguyên liệu</label>
                        <input type="text" class="filter-input" id="filterTenNguyenLieu" placeholder="Tìm kiếm nguyên liệu...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Phân loại</label>
                        <!-- Changed from text input to dropdown select -->
                        <select class="filter-input" id="filterPhanLoai">
                            <option value="">Tất cả phân loại</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Tiêu chuẩn</label>
                        <input type="text" class="filter-input" id="filterTieuChuan" placeholder="Tìm kiếm tiêu chuẩn...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Tên cơ sở ĐK</label>
                        <input type="text" class="filter-input" id="filterTenCoSoDK" placeholder="Tìm kiếm cơ sở đăng ký...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Tên CSSX NL</label>
                        <input type="text" class="filter-input" id="filterTenCSSXNL" placeholder="Tìm kiếm cơ sở sản xuất...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Địa chỉ CSSX NL</label>
                        <input type="text" class="filter-input" id="filterDiaChi" placeholder="Tìm kiếm địa chỉ...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Nước SXNL</label>
                        <input type="text" class="filter-input" id="filterNuocSXNL" placeholder="Tìm kiếm quốc gia...">
                    </div>
                </div>
            </div>
            
            <!-- Table Section -->
            <div class="table-section">
                <div class="table-header">
                    <div class="table-title">Dữ liệu nguyên liệu</div>
                    <div class="text-muted" id="pageInfo">Trang 1 của 1</div>
                </div>
                
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Số đăng ký</th>
                                <th>Tên thuốc</th>
                                <th>Ngày hết hạn SĐK</th>
                                <th>Tên nguyên liệu</th>
                                <th>Phân loại</th>
                                <th>Tiêu chuẩn</th>
                                <th>Tên cơ sở ĐK</th>
                                <th>Tên CSSX NL</th>
                                <th class="address">Địa chỉ CSSX NL</th>
                                <th>Nước SXNL</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Footer Section -->
            <div class="footer-section">
                <div class="pagination-container" id="paginationContainer"></div>
            </div>
        </div>
        
        <!-- Back to Top Button -->
        <button class="back-to-top" id="backToTopBtn" onclick="scrollToTop()">↑</button>

        
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <div class="spinner"></div>
                <div class="loading-text" id="loadingText">Đang tải dữ liệu nguyên liệu làm thuốc...</div>
            </div>
        </div>
        
        <script>
            // Global variables
            let allData = [];
            let filteredData = [];
            let currentPage = 1;
            let itemsPerPage = 100;
            let filtersVisible = false;
            let loadingQuoteInterval = null;
            
            // Random quotes cho loading screen
            const loadingQuotes = [
                "Đang tải dữ liệu nguyên liệu làm thuốc...",
                "Bạn vẫn đang chờ tải dữ liệu à? Nó lâu nhờ! Viết đơn thôi!",
                "Bạn muốn làm hòn đá?",
				"Quền cha nà neng néng neng nèng neng",
				"Đủ KPI chưa?",
                "Lửa hận thù đốt cháy ký ức hai ta...",
                "Ngủ đi, thức hoài, đừng làm nữa",
                "Chẳng phải phép màu, vậy sao chúng ta làm API?",
                "Bạn đã từng thử đếm xem cái này load bao lâu chưa? Có đứa khùng mới đếm.",
                "Dzì Dzị Trùi? Load lâu dữ vị...",
                "??? ... ??? ...",
                "Meow ",
				"Tín hiệu vũ trụ: -.-. .... ..- -.-. / -- --- - / -. --. .- -.-- / ...- ..- .. / ...- . / -.-.--",
				"Sống trong đời sống, cần có một Đơn xin nghỉ việc",
				"Job Application",
                "Tín hiệu vũ trụ: Matcha Latteeeee!!!!!",
                "Tôi là Bánh Khúc đây!",
                "Ăn chè Khúc Bạch không?",
                "Tín hiệu vũ trụ: Trà Sữa Chân Châu 70% ngọt",
                "Đang tải dữ liệu, vui lòng đợi...",
                "Đang xử lý dữ liệu, đừng bấm nút để tránh lỗi...",
                "Đang tải dữ liệu, đừng đóng trình duyệt...",
                "Đang tải dữ liệu, đừng đổi tab...",
                "Tín hiệu vũ trụ: Đóng laptop lại, đi ngủ liền!"
            ];
            
            // Utility functions
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            // Định dạng ngày theo dd/MM/yyyy
            function formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '';
                
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                
                return `${day}/${month}/${year}`;
            }
            
            function formatSoDangKy(soDangKy) {
                if (!soDangKy) return '';
                
                // Xử lý trường hợp có "(SĐK cũ: ...)"
                if (soDangKy.includes('(SĐK cũ:')) {
                    // Tách phần chính và phần SĐK cũ
                    const mainPart = soDangKy.split('(SĐK cũ:')[0].trim();
                    const oldPart = '(SĐK cũ:' + soDangKy.split('(SĐK cũ:')[1];
                    
                    // Trả về 2 dòng riêng biệt
                    return mainPart + '\n' + oldPart;
                }
                
                // Xử lý các trường hợp khác (nếu có \n)
                return soDangKy.replace(/\\n/g, '\n').replace(/\n/g, '\n');
            }
            
            // Cải thiện hàm truncate để hiển thị nhiều text hơn
            function smartTruncate(text, maxLength = 30) {
                if (!text) return '';
                if (text.length <= maxLength) return text;
                
                // Try to break at word boundaries
                const truncated = text.substring(0, maxLength);
                const lastSpace = truncated.lastIndexOf(' ');
                
                if (lastSpace > maxLength * 0.7) {
                    return truncated.substring(0, lastSpace) + '...';
                }
                
                return truncated + '...';
            }
            
            // Scroll functions
            function scrollToTop() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }
            
            function handleScroll() {
                const backToTopBtn = document.getElementById('backToTopBtn');
                if (window.pageYOffset > 300) {
                    backToTopBtn.classList.add('visible');
                } else {
                    backToTopBtn.classList.remove('visible');
                }
            }
            
            // UI Control functions
            function toggleFilters() {
                const filterSection = document.getElementById('filterSection');
                const toggleBtn = document.getElementById('toggleFiltersBtn');
                const btnText = document.getElementById('filterBtnText');
                
                filtersVisible = !filtersVisible;
                
                if (filtersVisible) {
                    filterSection.classList.add('expanded');
                    btnText.textContent = 'Ẩn bộ lọc';
                    toggleBtn.classList.add('active');
                } else {
                    filterSection.classList.remove('expanded');
                    btnText.textContent = 'Hiển thị bộ lọc';
                    toggleBtn.classList.remove('active');
                }
            }
            
            function updateItemsPerPage() {
                const select = document.getElementById('itemsPerPageSelect');
                itemsPerPage = parseInt(select.value);
                currentPage = 1;
                displayData(1);
            }
            
            // Data fetching - TỐI ƯU PERFORMANCE
            async function fetchData() {
                console.log('fetchData function called!');
                try {
                    console.log('Starting fetch request...');
                    showLoading(true);
                    
                    // Tối ưu: Fetch data ngay lập tức, không chờ chat widget
                    const response = await fetch('https://dichvucong.dav.gov.vn/api/services/app/nguyenLieuLamThuoc/GetAllServerPaging', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Access-Control-Allow-Origin': '*',
                            'Access-Control-Max-Age': '1000000'
                        },
                        body: JSON.stringify({
                            isActive: true,
                            ngayHetHanSoDangKyTu: null,
                            ngayHetHanSoDangKyToi: null,
                            ngayKyCongVanTu: null,
                            ngayKyCongVanToi: null,
                            skipCount: 0,
                            maxResultCount: 100000,
                            sorting: null
                        })
                    });

                    console.log('Response received:', response);
                    if (!response.ok) {
                        throw new Error(`Lỗi HTTP! trạng thái: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Data parsed:', data);
                    allData = data.result.items || [];
                    
                    console.log('Sample data item:', allData[0]);
                    console.log('First 5 drug names:', allData.slice(0, 5).map(item => item.tenThuoc));

                    filteredData = [...allData];
                    
                    populatePhanLoaiDropdown();
                    
                    updateStats();
                    displayData(1);
                    setupFilters();
                    
                } catch (error) {
                    console.error('Lỗi khi tải dữ liệu:', error);
                    alert('Lỗi khi tải dữ liệu. Vui lòng kiểm tra kết nối mạng và thử lại.');
                } finally {
                    showLoading(false);
                }
            }

            function populatePhanLoaiDropdown() {
				const phanLoaiSet = new Set();
				
				// Duyệt qua tất cả dữ liệu để lấy các phân loại duy nhất
				allData.forEach(item => {
					// Kiểm tra cả hai trường có thể chứa thông tin phân loại
					const phanLoai = item.phanLoaiNguyenLieu || item.phanLoai || '';
					if (phanLoai && phanLoai.toString().trim()) {
						phanLoaiSet.add(phanLoai.toString().trim());
					}
				});
				
				const dropdown = document.getElementById('filterPhanLoai');
				// Xóa tất cả options cũ
				dropdown.innerHTML = '<option value="">Tất cả phân loại</option>';
				
				// Sắp xếp và thêm các phân loại duy nhất vào dropdown
				const sortedPhanLoai = Array.from(phanLoaiSet).sort((a, b) => 
					a.localeCompare(b, 'vi', { sensitivity: 'base' })
				);
				
				sortedPhanLoai.forEach(phanLoai => {
					const option = document.createElement('option');
					option.value = phanLoai;
					option.textContent = phanLoai;
					dropdown.appendChild(option);
				});
				
				console.log('Đã tạo dropdown phân loại với', sortedPhanLoai.length, 'loại:', sortedPhanLoai);
			}
            
            // UI functions
            function showLoading(show) {
                document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
                
                if (show) {
                    // Bắt đầu thay đổi quote mỗi 2 giây
                    startLoadingQuotes();
                } else {
                    // Dừng thay đổi quote
                    stopLoadingQuotes();
                }
            }
            
            function startLoadingQuotes() {
                // Hiển thị quote đầu tiên
                const randomQuote = loadingQuotes[Math.floor(Math.random() * loadingQuotes.length)];
                document.getElementById('loadingText').textContent = randomQuote;
                
                // Thay đổi quote mỗi 2 giây
                loadingQuoteInterval = setInterval(() => {
                    const randomQuote = loadingQuotes[Math.floor(Math.random() * loadingQuotes.length)];
                    document.getElementById('loadingText').textContent = randomQuote;
                }, 25000);
            }
            
            function stopLoadingQuotes() {
                if (loadingQuoteInterval) {
                    clearInterval(loadingQuoteInterval);
                    loadingQuoteInterval = null;
                }
            }
            
            function updateStats() {
                document.getElementById('totalCount').textContent = allData.length.toLocaleString('vi-VN');
                
                const filteredInfo = document.getElementById('filteredInfo');
                const filteredCount = document.getElementById('filteredCount');
                
                if (filteredData.length !== allData.length) {
                    filteredCount.textContent = filteredData.length.toLocaleString('vi-VN');
                    filteredInfo.classList.remove('d-none');
                } else {
                    filteredInfo.classList.add('d-none');
                }
            }
            
            function updatePageInfo() {
                const totalPages = Math.ceil(filteredData.length / itemsPerPage);
                document.getElementById('pageInfo').textContent = `Trang ${currentPage} của ${totalPages}`;
            }
            
            function displayData(page) {
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = '';
                
                const start = (page - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                const pageData = filteredData.slice(start, end);

                pageData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.className = 'fade-in';
                    
                    if (index === 0) {
                        console.log('Displaying item:', item);
                    }
                    
                    row.innerHTML = `
                        <td class="col-stt">${start + index + 1}</td>
                        <td class="col-so-dk">${formatSoDangKy(item.soDangKy || '')}</td>
                        <td class="col-ten-thuoc" title="${item.tenThuoc || 'Không có tên thuốc'}">${item.tenThuoc || 'N/A'}</td>
                        <td class="col-ngay">${formatDate(item.ngayHetHanSoDangKy)}</td>
                        <td class="col-nguyen-lieu" title="${item.tenNguyenLieu || ''}">${item.tenNguyenLieu || ''}</td>
                        <td class="col-phan-loai" title="${item.phanLoaiNguyenLieu || item.phanLoai || ''}">${item.phanLoaiNguyenLieu || item.phanLoai || ''}</td>
                        <td class="col-tieu-chuan" title="${item.tieuChuanChatLuongNguyenLieu || ''}">${smartTruncate(item.tieuChuanChatLuongNguyenLieu, 15)}</td>
                        <td class="col-co-so-dk" title="${item.tenCoSoSanXuatThuoc || ''}">${item.tenCoSoSanXuatThuoc || ''}</td>
                        <td class="col-cssx-nl" title="${item.tenCoSoSanXuatNguyenLieu || ''}">${item.tenCoSoSanXuatNguyenLieu || ''}</td>
                        <td class="col-dia-chi" title="${item.diaChiCoSoSanXuatNguyenLieu || ''}">${smartTruncate(item.diaChiCoSoSanXuatNguyenLieu, 25)}</td>
                        <td class="col-nuoc">${item.nuocSanXuatNguyenLieu || ''}</td>
                    `;
                    tableBody.appendChild(row);
                });

                updatePagination(page);
                updatePageInfo();
            }
            
    function updatePagination(page) {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        const container = document.getElementById('paginationContainer');
        container.innerHTML = '';

        if (totalPages <= 1) return;

        // Previous button
        const prevBtn = createPageButton('Trước', page - 1, page === 1);
        container.appendChild(prevBtn);

        // Page numbers
        const startPage = Math.max(1, page - 2);
        const endPage = Math.min(totalPages, page + 2);

        if (startPage > 1) {
            container.appendChild(createPageButton('1', 1));
            if (startPage > 2) {
                container.appendChild(createPageButton('...', null, true));
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            container.appendChild(createPageButton(i.toString(), i, false, i === page));
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                container.appendChild(createPageButton('...', null, true));
            }
            container.appendChild(createPageButton(totalPages.toString(), totalPages));
        }

        // Next button
        const nextBtn = createPageButton('Sau', page + 1, page === totalPages);
        container.appendChild(nextBtn);
    }
            
    function createPageButton(text, pageNum, disabled = false, active = false) {
        const btn = document.createElement('a');
        btn.href = '#';
        btn.className = `page-btn ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;
        btn.textContent = text;
                
        if (!disabled && pageNum !== null) {
            btn.onclick = (e) => {
                e.preventDefault();
                changePage(pageNum);
            };
        }
                
        return btn;
    }
            
    function changePage(page) {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        if (page < 1 || page > totalPages) return;
                
        currentPage = page;
        displayData(page);
                
        // Tự động cuộn lên đầu trang khi chuyển trang
        scrollToTop();
    }
            
    // Filtering
    function setupFilters() {
        const filterIds = [
            'filterTenThuoc', 'filterSoDangKy', 'filterNgayHetHan', 'filterTenNguyenLieu',
            'filterPhanLoai', 'filterTieuChuan', 'filterTenCoSoDK', 'filterTenCSSXNL', 'filterDiaChi', 'filterNuocSXNL'
        ];
                
        filterIds.forEach(id => {
            const input = document.getElementById(id);
            input.addEventListener('input', debounce(filterData, 300));
            input.addEventListener('change', debounce(filterData, 300));
        });
                
        // Setup items per page selector
        document.getElementById('itemsPerPageSelect').addEventListener('change', updateItemsPerPage);
    }
            
    function filterData() {
        const filters = {
            tenThuoc: document.getElementById('filterTenThuoc').value.trim().toLowerCase(),
            soDangKy: document.getElementById('filterSoDangKy').value.trim().toLowerCase(),
            ngayHetHan: document.getElementById('filterNgayHetHan').value.trim().toLowerCase(),
            tenNguyenLieu: document.getElementById('filterTenNguyenLieu').value.trim().toLowerCase(),
            phanLoai: document.getElementById('filterPhanLoai').value.trim().toLowerCase(),
            tieuChuan: document.getElementById('filterTieuChuan').value.trim().toLowerCase(),
            tenCoSoDK: document.getElementById('filterTenCoSoDK').value.trim().toLowerCase(),
            tenCSSXNL: document.getElementById('filterTenCSSXNL').value.trim().toLowerCase(),
            diaChi: document.getElementById('filterDiaChi').value.trim().toLowerCase(),
            nuocSXNL: document.getElementById('filterNuocSXNL').value.trim().toLowerCase()
        };

        filteredData = allData.filter(item => {
            return (
                (!filters.tenThuoc || (item.tenThuoc || '').toLowerCase().includes(filters.tenThuoc)) &&
                (!filters.soDangKy || (item.soDangKy || '').toLowerCase().includes(filters.soDangKy)) &&
                (!filters.ngayHetHan || formatDate(item.ngayHetHanSoDangKy).toLowerCase().includes(filters.ngayHetHan)) &&
                (!filters.tenNguyenLieu || (item.tenNguyenLieu || '').toLowerCase().includes(filters.tenNguyenLieu)) &&
                (!filters.phanLoai || (item.phanLoaiNguyenLieu || item.phanLoai || '').toLowerCase() === filters.phanLoai) &&
                (!filters.tieuChuan || (item.tieuChuanChatLuongNguyenLieu || '').toLowerCase().includes(filters.tieuChuan)) &&
                (!filters.tenCoSoDK || (item.tenCoSoSanXuatThuoc || '').toLowerCase().includes(filters.tenCoSoDK)) &&
                (!filters.tenCSSXNL || (item.tenCoSoSanXuatNguyenLieu || '').toLowerCase().includes(filters.tenCSSXNL)) &&
                (!filters.diaChi || (item.diaChiCoSoSanXuatNguyenLieu || '').toLowerCase().includes(filters.diaChi)) &&
                (!filters.nuocSXNL || (item.nuocSanXuatNguyenLieu || '').toLowerCase().includes(filters.nuocSXNL))
            );
        });
                
        updateStats();
        currentPage = 1;
        displayData(1);
    }
            
    // Excel export
    function exportToExcel() {
        try {
            const headers = [
                'STT', 'Số đăng ký', 'Tên thuốc', 'Ngày hết hạn SĐK', 'Tên nguyên liệu',
                'Phân loại', 'Tiêu chuẩn', 'Tên cơ sở ĐK', 'Tên CSSX NL', 'Địa chỉ CSSX NL', 'Nước SXNL'
            ];
                    
            const ws = XLSX.utils.aoa_to_sheet([headers]);
                    
            const data = filteredData.map((item, index) => [
                index + 1,
                formatSoDangKy(item.soDangKy || ''),
                item.tenThuoc || '',
                formatDate(item.ngayHetHanSoDangKy),
                item.tenNguyenLieu || '',
                item.phanLoaiNguyenLieu || item.phanLoai || '',
                item.tieuChuanChatLuongNguyenLieu || '',
                item.tenCoSoSanXuatThuoc || '',
                item.tenCoSoSanXuatNguyenLieu || '',
                item.diaChiCoSoSanXuatNguyenLieu || '',
                item.nuocSanXuatNguyenLieu || ''
            ]);
                    
            XLSX.utils.sheet_add_aoa(ws, data, { origin: 'A2' });
                    
            ws['!cols'] = [
                { wch: 8 }, { wch: 25 }, { wch: 35 }, { wch: 18 }, { wch: 35 },
                { wch: 20 }, { wch: 35 }, { wch: 35 }, { wch: 40 }, { wch: 15 }
            ];
                    
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const address = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[address]) continue;
                            
                    if (R === 0) {
                        ws[address].s = {
                            font: { bold: true, name: 'Times New Roman', sz: 12 },
                            fill: { fgColor: { rgb: 'E6F3FF' } },
                            alignment: { vertical: 'center', horizontal: 'center', wrapText: true },
                            border: {
                                top: { style: 'thin', color: { rgb: '000000' } },
                                bottom: { style: 'thin', color: { rgb: '000000' } },
                                left: { style: 'thin', color: { rgb: '000000' } },
                                right: { style: 'thin', color: { rgb: '000000' } }
                            }
                        };
                    } else {
                        ws[address].s = {
                            font: { name: 'Times New Roman', sz: 12 },
                            alignment: { vertical: 'center', horizontal: 'center', wrapText: true },
                            border: {
                                top: { style: 'thin', color: { rgb: '000000' } },
                                bottom: { style: 'thin', color: { rgb: '000000' } },
                                left: { style: 'thin', color: { rgb: '000000' } },
                                right: { style: 'thin', color: { rgb: '000000' } }
                            }
                        };
                    }
                }
            }
                    
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Nguyên liệu làm thuốc');
                    
            const fileName = `nguyen-lieu-lam-thuoc-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
                    
        } catch (error) {
            console.error('Lỗi khi xuất Excel:', error);
            alert('Lỗi khi xuất Excel. Vui lòng thử lại.');
        }
    }

    function openChatRoom() {
        window.open('#', '_blank');
    }
            
            // Event listeners
            console.log('Setting up event listeners...');
            window.addEventListener('load', () => {
                console.log('Page loaded, calling fetchData...');
                fetchData();
            });
            window.addEventListener('scroll', handleScroll);
            window.addEventListener('resize', debounce(() => {
                displayData(currentPage);
            }, 250));
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    exportToExcel();
                }
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    toggleFilters();
                }
            });
        </script>
    </body>
    </html>

